# 🔧 图词（VisionLex）图片上传问题排查指南

## 📋 问题诊断步骤

### 第一步：打开浏览器控制台

1. **打开开发者工具**：按 `F12` 或右键点击页面选择"检查"
2. **切换到 Console 标签**：查看控制台输出
3. **清空控制台**：点击 🚫 图标清空旧日志
4. **尝试上传图片**：观察控制台输出

### 第二步：查看日志流程

正常情况下，您应该看到以下日志序列：

```
[图片上传] 开始处理图片: xxx.jpg 123456 bytes
[图片上传] 验证图片格式和大小...
[图片上传] 验证通过
[图片上传] 图片较小，直接转换为 base64...
[图片上传] 转换完成
[图片上传] ✅ 图片上传成功

[主流程] 开始图片上传和分析流程
[主流程] 检查 API 密钥配置...
[主流程] API 密钥已配置，继续...
[主流程] 重置分析状态和音频...
[主流程] 调用 AI 分析...

[AI 分析] 开始分析图片...
[AI 分析] 图片数据长度: xxxxx bytes
[AI 分析] 发送请求到 Moonshot API...
[AI 分析] API 地址: https://api.moonshot.cn/v1/chat/completions
[AI 分析] 模型: moonshot-v1-8k-vision-preview
[AI 分析] 收到响应，状态码: 200
[AI 分析] 解析响应数据...
[AI 分析] 收到 AI 响应: {...}
[AI 分析] JSON 解析成功: {...}
[AI 分析] ✅ 分析完成: apple

[主流程] ✅ 分析成功，处理结果...
[主流程] 添加到历史记录...
[主流程] ✅ 所有步骤完成！
```

### 第三步：根据日志定位问题

#### 🔴 情况 1：卡在 `[图片上传] 开始处理图片...` 之后

**可能原因**：
- 图片文件损坏
- 图片格式不支持
- 图片过大（超过 10MB）

**解决方案**：
1. 尝试使用不同的图片
2. 确保图片格式为 JPG/PNG/GIF/WEBP
3. 确保图片小于 10MB

#### 🟡 情况 2：显示 `❌ API 密钥未配置`

**解决方案**：
1. 在项目根目录创建 `.env` 文件
2. 添加以下内容：
   ```
   VITE_KIMI_API_KEY=sk-your-api-key-here
   ```
3. 获取 API Key：https://platform.moonshot.cn/console/api-keys
4. **重要**：保存后必须重启开发服务器：
   ```bash
   # 按 Ctrl+C 停止服务器
   npm run dev  # 或 pnpm dev
   ```

#### 🟠 情况 3：卡在 `[AI 分析] 发送请求到 Moonshot API...` 之后

**可能原因**：
- 网络连接问题
- API 密钥无效
- Moonshot API 服务异常

**解决方案**：
1. 检查网络连接是否正常
2. 验证 API Key 是否正确：
   - 登录 https://platform.moonshot.cn/console/api-keys
   - 确认密钥状态为"启用"
   - 检查是否有可用余额
3. 等待 30 秒，系统会自动超时并显示错误
4. 点击"重新分析"按钮重试

#### 🔵 情况 4：显示 `分析超时（30秒）`

**解决方案**：
1. 检查网络速度
2. 尝试使用更小的图片
3. 点击"重新分析"按钮重试
4. 如果持续超时，可能是 Moonshot API 服务繁忙，稍后再试

#### ⚫ 情况 5：显示 API 错误（状态码 401/403）

**错误信息示例**：
```
[AI 分析] ❌ API 错误: {error: {message: "Invalid authentication"}}
```

**解决方案**：
1. API Key 配置错误或已失效
2. 检查 `.env` 文件中的 `VITE_KIMI_API_KEY` 是否正确
3. 确保 Key 以 `sk-` 开头
4. 重新生成新的 API Key
5. **必须重启开发服务器**

#### 🟣 情况 6：显示数据解析错误

**错误信息示例**：
```
[AI 分析] ❌ JSON 解析错误: Unexpected token
[AI 分析] 原始内容: ...
```

**解决方案**：
1. 这通常是 AI 返回格式不正确
2. 检查图片内容是否过于复杂或模糊
3. 尝试使用更清晰简单的图片
4. 查看原始内容，如果 AI 返回了错误信息而非 JSON，可能是余额不足

## 🛠️ 快速测试方法

### 方法 1：最小化测试

```bash
# 1. 确认 .env 文件存在且配置正确
cat .env

# 应该看到：
# VITE_KIMI_API_KEY=sk-...

# 2. 重启服务器
npm run dev
```

### 方法 2：使用简单图片

1. 准备一张**简单、清晰、较小**的图片（如苹果、猫、狗等）
2. 文件大小建议 < 1MB
3. 格式建议使用 JPG 或 PNG

### 方法 3：手动测试 API

在浏览器控制台执行以下代码测试 API 连接：

```javascript
// 替换 YOUR_API_KEY 为你的实际密钥
fetch('https://api.moonshot.cn/v1/models', {
  headers: {
    'Authorization': 'Bearer YOUR_API_KEY'
  }
})
.then(r => r.json())
.then(d => console.log('✅ API 连接成功', d))
.catch(e => console.error('❌ API 连接失败', e));
```

## 📞 常见问题 FAQ

### Q1：为什么重启服务器很重要？

**A**：Vite 在构建时读取环境变量，修改 `.env` 后必须重启才能生效。

### Q2：如何确认 API Key 是否有效？

**A**：
1. 登录 https://platform.moonshot.cn/console
2. 检查"余额"是否充足
3. 检查 API Key 状态是否为"启用"
4. 使用上面的手动测试代码验证

### Q3：为什么有时快有时慢？

**A**：受以下因素影响：
- 图片大小（越大越慢）
- 图片内容复杂度
- 网络速度
- Moonshot API 服务器负载

### Q4：能取消正在进行的分析吗？

**A**：可以！在"AI 分析中..."状态下会显示"取消"按钮。

### Q5：分析失败后能重试吗？

**A**：可以！失败后会显示"重新分析"按钮，无需重新上传图片。

## 🔍 高级调试

### 查看完整请求详情

1. 打开开发者工具的 **Network** 标签
2. 上传图片并分析
3. 找到 `chat/completions` 请求
4. 查看：
   - **Headers**：检查 Authorization 是否正确
   - **Payload**：查看发送的数据
   - **Response**：查看返回结果
   - **Timing**：查看耗时

### 检查内存使用

```javascript
// 在控制台执行
console.log('内存使用:', performance.memory);
```

如果内存占用过高，刷新页面重试。

## 📝 报告问题

如果按照以上步骤仍无法解决，请提供以下信息：

1. **浏览器和版本**：如 Chrome 120.0.6099.109
2. **完整的控制台日志**：从开始上传到错误发生的所有日志
3. **图片信息**：大小、格式、尺寸（不要发送图片本身）
4. **错误截图**：包含错误提示和控制台
5. **环境变量配置**：确认是否配置了 API Key（不要暴露实际密钥）

---

**更新时间**：2024-11-01  
**版本**：v1.0.0

